<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>哈尔滨商业大学 校园网络优化深入浅出 | racel.researches</title><meta name=keywords content="校园网,openwrt,路由器,计算机网络"><meta name=description content="记录我在不断折腾的过程中，所遇到的各种问题和得到的解决方案。"><meta name=author content="racel"><link rel=canonical href=https://racel.dev/posts/hrbcu-network/><link crossorigin=anonymous href=/assets/css/stylesheet.4599eadb9eb2ad3d0a8d6827b41a8fda8f2f4af226b63466c09c5fddbc8706b7.css integrity="sha256-RZnq256yrT0KjWgntBqP2o8vSvImtjRmwJxf3byHBrc=" rel="preload stylesheet" as=style><link rel=icon href=https://racel.dev/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://racel.dev/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://racel.dev/favicon-32x32.png><link rel=apple-touch-icon href=https://racel.dev/apple-touch-icon.png><link rel=mask-icon href=https://racel.dev/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="哈尔滨商业大学 校园网络优化深入浅出"><meta property="og:description" content="记录我在不断折腾的过程中，所遇到的各种问题和得到的解决方案。"><meta property="og:type" content="article"><meta property="og:url" content="https://racel.dev/posts/hrbcu-network/"><meta property="article:section" content="posts"><meta property="og:site_name" content="racel.researches"><meta name=twitter:card content="summary"><meta name=twitter:title content="哈尔滨商业大学 校园网络优化深入浅出"><meta name=twitter:description content="记录我在不断折腾的过程中，所遇到的各种问题和得到的解决方案。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://racel.dev/posts/"},{"@type":"ListItem","position":2,"name":"哈尔滨商业大学 校园网络优化深入浅出","item":"https://racel.dev/posts/hrbcu-network/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"哈尔滨商业大学 校园网络优化深入浅出","name":"哈尔滨商业大学 校园网络优化深入浅出","description":"记录我在不断折腾的过程中，所遇到的各种问题和得到的解决方案。","keywords":["校园网","openwrt","路由器","计算机网络"],"articleBody":"面对的几个主要问题 学校的学生寝室楼的宽带运营商处于垄断状态，均为中国联通，以80元/月 50Mbps/2终端的价格提供给学生，昂贵且难用。 学校寝室楼的移动流量信号差，速率低，延迟高且有流量限制，属于勉强可以使用的程度。 实际上，针对第二个问题，我曾经尝试过使用 CPE(5G模块为RM520N-GL)，但难以忍受高延迟和低带宽，最后放弃使用。\n这样的话，我只能尝试采用学校联通所提供的宽带，想办法尽可能优化。\n优化方案 A校区的寝室楼宽带网络提供了光纤入寝，租用宽带的同时也可以抵押 300 元得到校园网定制的中国联通光猫。虽然抵押的光猫有WIFI功能，但是上游下发注册会自动关闭管理后台和WIFI功能。因此，可以外接无线路由器，实现同寝室网络共享。 上述基础的网络共享实际上只使用了一个终端，而通过单线多播可以将多终端的速率叠加，提高带宽。 优化过程 同寝室网络共享 硬件要求 设备 用途 光猫 光信号调解 无线路由器 供终端设备无线连接 我购置了一台红米 RM2100，价格低廉，OpenWRT 固件数量多，但缺点就是内存太小，单设备无法承担单线多播的责任\n无线路由器既可以选择付费固件（往往捆绑硬件出售），也可以自行购买，安装自定义固件\n但是，安装的固件至少需要有UA2F插件，用于防止被上游上网行为管理系统的多终端检测阻断\n这里的路由设置教程遵循OpenWRT系统\n路由设置 将路由器的 WAN 口连接到光猫的 LAN 口 如果你知道路由器的默认SSID和密钥，你可以使用终端连接到路由器；如果你不知道，你可以将你有 RJ45 网口的电脑连接到路由器的任意一个 LAN 口。OpenWRT 的默认登录地址即为网关，默认网关地址和管理页面的账户一般在固件下载地址有所提供。这时，登录 OpenWRT 的管理页面。 然后在路由器中将 WAN 口设置为 DHCP 客户端协议。这时，在接口中可以看到WAN已经获取到了 IPv4 地址1 勾选 UA2F 的全部选项并启动 在无线选项中，设置好 SSID 和密钥，并启用。 经过上述的简单设置，此时可以访问校园网的终端登录页面，登录后即可得到公网访问权限。\n并且只有在 24H 内没有过连接，登录才会过期。因为，晚上断电，但是早晨路由器自启动就会维持这个登录状态。\n单线多播提高带宽 这是最麻烦的一步，因为单线多播带来了很多不兼容性和硬件要求\n概括来说就是，使用 OpenWRT 的 MWAN3(负载均衡) 和 Syncdial(多播) 插件来实现单线多播，以及多播后的负载均衡。 但是 MWAN3 因为使用了 iptables 的标记功能，会与同时使用这个功能的 UA2F 发生冲突，因为我们也无法继续使用 UA2F 了。这样，我们只能使用 UA3F2 搭配 Clash 使用了。这要求路由器的内存不能过小，但是我的 RM2100 内存过小，因此我购买了 FriendlyElec R5s 软路由，充当路由器的上游，仅让 RM2100 作为 AP 使用。\n首先需要将 RM2100 配置为 AP，操作较为简单这里不做赘述。\n固件 \u0026 插件安装使用 我给我的 R5s 安装了 QWRT 闭源固件，也可以选择其他固件，差别不大 需要安装多播(luci-app-syncdial)和负载均衡(luci-app-mwan3)插件 设置好多播线路数量，多播插件会自动配置负载均衡，可以根据需要自行修改策略 自动配置的负载均衡接口是 PPPoE，需要手动将这些接口修改为 DHCP 客户端 同时根据 UA3F 给出的 OpenWRT Luci 安装教程，安装 UA3F UA3F 还需要 Clash 来进行流量代理，可以安装 OpenClash 或者 ShellClash，这里我使用了 OpenClash，安装和设置起来可以直接通过网页界面进行，操作简便3 (可选) 安装 AdGuard Home，建立私人 DNS，防止劫持，进行广告过滤。 由于具体的安装过程在网络上都可以搜索得到，这里只给出我踩过的坑。\n多播的设置里，不要勾选绑定物理接口 高版本的 MWAN3 在设置好后，在每次设备启动后，可能会出现接口状态被禁用的情况，这时候需要手动执行mwan3 restart。来彻底解决这个问题，可以在启动项脚本中添加mwan3 restart这条指令，实现在每次重启后自动对 MWAN3 进行重启 OpenClash 中不要开启绕过中国大陆，否则有部分流量将不会经过 UA3F，可能会造成网络阻断 负载均衡登录 如果需要手动登录，可以使用curl --interface 当然，也可以借助负载均衡提供的事件响应脚本，在每次被强制登出后，自动执行重新登录\n下面给出我的 python 脚本\n#!/usr/bin/python3 import requests import re import random import socket import sys import subprocess INIT_URL = \"http://172.17.100.10/\" HRBCU_PORTAL_API = \"http://172.17.100.10:801/eportal/portal/\" interface = sys.argv[1] device = sys.argv[2] action = sys.argv[3] class HTTPAdapterWithSocketOptions(requests.adapters.HTTPAdapter): def __init__(self, *args, **kwargs): self.socket_options = kwargs.pop(\"socket_options\", None) super(HTTPAdapterWithSocketOptions, self).__init__(*args, **kwargs) def init_poolmanager(self, *args, **kwargs): if self.socket_options is not None: kwargs[\"socket_options\"] = self.socket_options super(HTTPAdapterWithSocketOptions, self).init_poolmanager(*args, **kwargs) adapter = HTTPAdapterWithSocketOptions(socket_options=[( socket.SOL_SOCKET, socket.SO_BINDTODEVICE, device.encode('utf-8'))]) session = requests.session() session.mount(\"http://\", adapter) session.mount(\"https://\", adapter) def logging(str): print(\"[*] \" + str) subprocess.call( [f'logger \"[*] ' + str + '\"'], shell=True ) def init(): logging(\"initializing\") global ip, randnum init_res = session.get(INIT_URL) # print(init_res.content) if 'hsydxka' in str(init_res.content): ip = re.search(\"v4ip='(.*?)'\", init_res.text).group(1) else: ip = re.search(\"v46ip='(.*?)'\", init_res.text).group(1) randnum = str(random.randint(1000, 9999)) logging(\"client_ip:\" + ip) logging(\"randint:\" + randnum) def login(): params = { 'callback': \"dr1003\", 'login_method': 1, 'user_account': username, 'user_password': password, 'wlan_user_ip': ip, 'wlan_user_mac': '000000000000', 'wlan_ac_ip': '', 'wlan_ac_name': '', 'jsVersion': 4.1, 'terminal_type': 1, 'v': randnum, 'lang': \"zh\" } res = session.get(HRBCU_PORTAL_API + \"login\", params=params) logging(\"response: \" + res.text) if '认证成功' in res.text: logging('logged in successfully') elif '已经在线' in res.text: logging('login failed') if __name__ == '__main__': if action == \"disconnected\" and device.find(\"macvlan\") != -1: global username, password username = \"\" password = \"\" try: init() login() except Exception: subprocess.call( # [f\"ifdown {interface} \u0026\u0026 sleep 2 \u0026\u0026 ifup {interface} \u0026\u0026 sleep 2\"], shell=True [f\"sleep 30\"], shell=True ) init() login() 同时在事件响应脚本内追加一行/usr/bin/python3 /root/hrbcu-net.py $INTERFACE $DEVICE $ACTION即可\nAdGuard Home 配置 校园网截至现在还没有支持 IPv6 ↩︎\n校园网防检测: UA3F - 新一代 UA 修改方法 ↩︎\nUA3F 与 Clash 从零开始的部署教程 ↩︎\n","wordCount":"385","inLanguage":"en","datePublished":"0001-01-01T00:00:00Z","dateModified":"0001-01-01T00:00:00Z","author":{"@type":"Person","name":"racel"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://racel.dev/posts/hrbcu-network/"},"publisher":{"@type":"Organization","name":"racel.researches","logo":{"@type":"ImageObject","url":"https://racel.dev/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://racel.dev/ accesskey=h title="racel.researches (Alt + H)">racel.researches</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://racel.dev/categories/ title=categories><span>categories</span></a></li><li><a href=https://racel.dev/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://racel.dev/>Home</a>&nbsp;»&nbsp;<a href=https://racel.dev/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">哈尔滨商业大学 校园网络优化深入浅出</h1><div class=post-description>记录我在不断折腾的过程中，所遇到的各种问题和得到的解决方案。</div><div class=post-meta>2 min&nbsp;·&nbsp;385 words&nbsp;·&nbsp;racel</div></header><div class=post-content><h1 id=面对的几个主要问题>面对的几个主要问题<a hidden class=anchor aria-hidden=true href=#面对的几个主要问题>#</a></h1><ul><li>学校的学生寝室楼的宽带运营商处于垄断状态，均为中国联通，以<code>80元/月 50Mbps/2终端</code>的价格提供给学生，昂贵且难用。</li><li>学校寝室楼的移动流量信号差，速率低，延迟高且有流量限制，属于勉强可以使用的程度。</li></ul><hr><p>实际上，针对第二个问题，我曾经尝试过使用 CPE(5G模块为<code>RM520N-GL</code>)，但难以忍受高延迟和低带宽，最后放弃使用。<br>这样的话，我只能尝试采用学校联通所提供的宽带，想办法尽可能优化。</p><h2 id=优化方案>优化方案<a hidden class=anchor aria-hidden=true href=#优化方案>#</a></h2><ol><li>A校区的寝室楼宽带网络提供了<strong>光纤入寝</strong>，租用宽带的同时也可以抵押 300 元得到校园网定制的中国联通光猫。虽然抵押的光猫有WIFI功能，但是上游下发注册会自动关闭管理后台和WIFI功能。因此，可以外接无线路由器，实现同寝室网络共享。</li><li>上述基础的网络共享实际上只使用了一个终端，而通过单线多播可以将多终端的速率叠加，提高带宽。</li></ol><h1 id=优化过程>优化过程<a hidden class=anchor aria-hidden=true href=#优化过程>#</a></h1><h2 id=同寝室网络共享>同寝室网络共享<a hidden class=anchor aria-hidden=true href=#同寝室网络共享>#</a></h2><h3 id=硬件要求>硬件要求<a hidden class=anchor aria-hidden=true href=#硬件要求>#</a></h3><table><thead><tr><th>设备</th><th>用途</th></tr></thead><tbody><tr><td>光猫</td><td>光信号调解</td></tr><tr><td>无线路由器</td><td>供终端设备无线连接</td></tr></tbody></table><p>我购置了一台<code>红米 RM2100</code>，价格低廉，OpenWRT 固件数量多，但缺点就是内存太小，单设备无法承担单线多播的责任<br>无线路由器既可以选择付费固件（往往捆绑硬件出售），也可以自行购买，安装自定义固件<br>但是，安装的固件<strong>至少</strong>需要有<code>UA2F</code>插件，用于防止被上游上网行为管理系统的多终端检测阻断<br>这里的路由设置教程遵循<code>OpenWRT</code>系统</p><h3 id=路由设置>路由设置<a hidden class=anchor aria-hidden=true href=#路由设置>#</a></h3><ol><li>将路由器的 WAN 口连接到光猫的 LAN 口</li><li>如果你知道路由器的默认SSID和密钥，你可以使用终端连接到路由器；如果你不知道，你可以将你有 RJ45 网口的电脑连接到路由器的任意一个 LAN 口。OpenWRT 的默认登录地址即为网关，默认网关地址和管理页面的账户一般在固件下载地址有所提供。这时，登录 OpenWRT 的管理页面。</li><li>然后在路由器中将 WAN 口设置为 DHCP 客户端协议。这时，在<code>接口</code>中可以看到<code>WAN</code>已经获取到了 IPv4 地址<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></li><li>勾选 <code>UA2F</code> 的全部选项并启动</li><li>在<code>无线</code>选项中，设置好 SSID 和密钥，并启用。</li></ol><hr><p>经过上述的简单设置，此时可以访问校园网的<a href=http://172.17.100.10/a79.htm>终端登录页面</a>，登录后即可得到公网访问权限。<br>并且只有在 24H 内没有过连接，登录才会过期。因为，晚上断电，但是早晨路由器自启动就会维持这个登录状态。</p><h2 id=单线多播提高带宽>单线多播提高带宽<a hidden class=anchor aria-hidden=true href=#单线多播提高带宽>#</a></h2><p>这是最麻烦的一步，因为单线多播带来了很多不兼容性和硬件要求<br>概括来说就是，使用 OpenWRT 的 MWAN3(负载均衡) 和 Syncdial(多播) 插件来实现单线多播，以及多播后的负载均衡。
但是 MWAN3 因为使用了 iptables 的标记功能，会与同时使用这个功能的 UA2F 发生冲突，因为我们也无法继续使用 UA2F 了。这样，我们只能使用 UA3F<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> 搭配 Clash 使用了。这要求路由器的内存不能过小，但是我的 RM2100 内存过小，因此我购买了 <code>FriendlyElec R5s</code> 软路由，充当路由器的上游，仅让 RM2100 作为 AP 使用。<br>首先需要将 RM2100 配置为 AP，操作较为简单这里不做赘述。</p><h3 id=固件--插件安装使用>固件 & 插件安装使用<a hidden class=anchor aria-hidden=true href=#固件--插件安装使用>#</a></h3><ul><li>我给我的 R5s 安装了 QWRT 闭源固件，也可以选择其他固件，差别不大</li><li>需要安装多播(<code>luci-app-syncdial</code>)和负载均衡(<code>luci-app-mwan3</code>)插件</li><li>设置好多播线路数量，多播插件会自动配置负载均衡，可以根据需要自行修改策略</li><li>自动配置的负载均衡接口是 PPPoE，需要手动将这些接口修改为 DHCP 客户端</li><li>同时根据 UA3F 给出的 OpenWRT Luci 安装教程，安装 UA3F</li><li>UA3F 还需要 Clash 来进行流量代理，可以安装 OpenClash 或者 ShellClash，这里我使用了 OpenClash，安装和设置起来可以直接通过网页界面进行，操作简便<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></li><li>(可选) 安装 AdGuard Home，建立私人 DNS，防止劫持，进行广告过滤。</li></ul><hr><p>由于具体的安装过程在网络上都可以搜索得到，这里只给出我踩过的坑。</p><ul><li>多播的设置里，不要勾选<code>绑定物理接口</code></li><li>高版本的 MWAN3 在设置好后，在每次设备启动后，可能会出现接口状态被禁用的情况，这时候需要手动执行<code>mwan3 restart</code>。来彻底解决这个问题，可以在启动项脚本中添加<code>mwan3 restart</code>这条指令，实现在每次重启后自动对 MWAN3 进行重启</li><li>OpenClash 中不要开启绕过中国大陆，否则有部分流量将不会经过 UA3F，可能会造成网络阻断</li></ul><h3 id=负载均衡登录>负载均衡登录<a hidden class=anchor aria-hidden=true href=#负载均衡登录>#</a></h3><p>如果需要手动登录，可以使用<code>curl --interface &lt;URL></code><br>当然，也可以借助负载均衡提供的事件响应脚本，在每次被强制登出后，自动执行重新登录<br>下面给出我的 python 脚本</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=ch>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>requests</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>re</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>random</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>socket</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>sys</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>subprocess</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>INIT_URL</span> <span class=o>=</span> <span class=s2>&#34;http://172.17.100.10/&#34;</span>
</span></span><span class=line><span class=cl><span class=n>HRBCU_PORTAL_API</span> <span class=o>=</span> <span class=s2>&#34;http://172.17.100.10:801/eportal/portal/&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>interface</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>device</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span>
</span></span><span class=line><span class=cl><span class=n>action</span> <span class=o>=</span> <span class=n>sys</span><span class=o>.</span><span class=n>argv</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>class</span> <span class=nc>HTTPAdapterWithSocketOptions</span><span class=p>(</span><span class=n>requests</span><span class=o>.</span><span class=n>adapters</span><span class=o>.</span><span class=n>HTTPAdapter</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>socket_options</span> <span class=o>=</span> <span class=n>kwargs</span><span class=o>.</span><span class=n>pop</span><span class=p>(</span><span class=s2>&#34;socket_options&#34;</span><span class=p>,</span> <span class=kc>None</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>HTTPAdapterWithSocketOptions</span><span class=p>,</span> <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=fm>__init__</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>def</span> <span class=nf>init_poolmanager</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>socket_options</span> <span class=ow>is</span> <span class=ow>not</span> <span class=kc>None</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>kwargs</span><span class=p>[</span><span class=s2>&#34;socket_options&#34;</span><span class=p>]</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>socket_options</span>
</span></span><span class=line><span class=cl>        <span class=nb>super</span><span class=p>(</span><span class=n>HTTPAdapterWithSocketOptions</span><span class=p>,</span>
</span></span><span class=line><span class=cl>              <span class=bp>self</span><span class=p>)</span><span class=o>.</span><span class=n>init_poolmanager</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>adapter</span> <span class=o>=</span> <span class=n>HTTPAdapterWithSocketOptions</span><span class=p>(</span><span class=n>socket_options</span><span class=o>=</span><span class=p>[(</span>
</span></span><span class=line><span class=cl>    <span class=n>socket</span><span class=o>.</span><span class=n>SOL_SOCKET</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>SO_BINDTODEVICE</span><span class=p>,</span> <span class=n>device</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s1>&#39;utf-8&#39;</span><span class=p>))])</span>
</span></span><span class=line><span class=cl><span class=n>session</span> <span class=o>=</span> <span class=n>requests</span><span class=o>.</span><span class=n>session</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>mount</span><span class=p>(</span><span class=s2>&#34;http://&#34;</span><span class=p>,</span> <span class=n>adapter</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>session</span><span class=o>.</span><span class=n>mount</span><span class=p>(</span><span class=s2>&#34;https://&#34;</span><span class=p>,</span> <span class=n>adapter</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>logging</span><span class=p>(</span><span class=nb>str</span><span class=p>):</span>
</span></span><span class=line><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=s2>&#34;[*] &#34;</span> <span class=o>+</span> <span class=nb>str</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>subprocess</span><span class=o>.</span><span class=n>call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=sa>f</span><span class=s1>&#39;logger &#34;[*] &#39;</span> <span class=o>+</span> <span class=nb>str</span> <span class=o>+</span> <span class=s1>&#39;&#34;&#39;</span><span class=p>],</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>    <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>init</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=p>(</span><span class=s2>&#34;initializing&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>global</span> <span class=n>ip</span><span class=p>,</span> <span class=n>randnum</span>
</span></span><span class=line><span class=cl>    <span class=n>init_res</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>INIT_URL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=c1># print(init_res.content)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;hsydxka&#39;</span> <span class=ow>in</span> <span class=nb>str</span><span class=p>(</span><span class=n>init_res</span><span class=o>.</span><span class=n>content</span><span class=p>):</span>
</span></span><span class=line><span class=cl>        <span class=n>ip</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;v4ip=&#39;(.*?)&#39;&#34;</span><span class=p>,</span> <span class=n>init_res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>ip</span> <span class=o>=</span> <span class=n>re</span><span class=o>.</span><span class=n>search</span><span class=p>(</span><span class=s2>&#34;v46ip=&#39;(.*?)&#39;&#34;</span><span class=p>,</span> <span class=n>init_res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span><span class=o>.</span><span class=n>group</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>randnum</span> <span class=o>=</span> <span class=nb>str</span><span class=p>(</span><span class=n>random</span><span class=o>.</span><span class=n>randint</span><span class=p>(</span><span class=mi>1000</span><span class=p>,</span> <span class=mi>9999</span><span class=p>))</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=p>(</span><span class=s2>&#34;client_ip:&#34;</span> <span class=o>+</span> <span class=n>ip</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=p>(</span><span class=s2>&#34;randint:&#34;</span> <span class=o>+</span> <span class=n>randnum</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>def</span> <span class=nf>login</span><span class=p>():</span>
</span></span><span class=line><span class=cl>    <span class=n>params</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;callback&#39;</span><span class=p>:</span> <span class=s2>&#34;dr1003&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;login_method&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;user_account&#39;</span><span class=p>:</span> <span class=n>username</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;user_password&#39;</span><span class=p>:</span> <span class=n>password</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;wlan_user_ip&#39;</span><span class=p>:</span> <span class=n>ip</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;wlan_user_mac&#39;</span><span class=p>:</span> <span class=s1>&#39;000000000000&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;wlan_ac_ip&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;wlan_ac_name&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;jsVersion&#39;</span><span class=p>:</span> <span class=mf>4.1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;terminal_type&#39;</span><span class=p>:</span> <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;v&#39;</span><span class=p>:</span> <span class=n>randnum</span><span class=p>,</span>
</span></span><span class=line><span class=cl>        <span class=s1>&#39;lang&#39;</span><span class=p>:</span> <span class=s2>&#34;zh&#34;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>res</span> <span class=o>=</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>HRBCU_PORTAL_API</span> <span class=o>+</span> <span class=s2>&#34;login&#34;</span><span class=p>,</span> <span class=n>params</span><span class=o>=</span><span class=n>params</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=n>logging</span><span class=p>(</span><span class=s2>&#34;response: &#34;</span> <span class=o>+</span> <span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=s1>&#39;认证成功&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=p>(</span><span class=s1>&#39;logged in successfully&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=k>elif</span> <span class=s1>&#39;已经在线&#39;</span> <span class=ow>in</span> <span class=n>res</span><span class=o>.</span><span class=n>text</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=n>logging</span><span class=p>(</span><span class=s1>&#39;login failed&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s1>&#39;__main__&#39;</span><span class=p>:</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=n>action</span> <span class=o>==</span> <span class=s2>&#34;disconnected&#34;</span> <span class=ow>and</span> <span class=n>device</span><span class=o>.</span><span class=n>find</span><span class=p>(</span><span class=s2>&#34;macvlan&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span><span class=p>:</span>
</span></span><span class=line><span class=cl>        <span class=k>global</span> <span class=n>username</span><span class=p>,</span> <span class=n>password</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>username</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>        <span class=n>password</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>login</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>except</span> <span class=ne>Exception</span><span class=p>:</span>
</span></span><span class=line><span class=cl>            <span class=n>subprocess</span><span class=o>.</span><span class=n>call</span><span class=p>(</span>
</span></span><span class=line><span class=cl>                <span class=c1># [f&#34;ifdown {interface} &amp;&amp; sleep 2 &amp;&amp; ifup {interface} &amp;&amp; sleep 2&#34;], shell=True</span>
</span></span><span class=line><span class=cl>                <span class=p>[</span><span class=sa>f</span><span class=s2>&#34;sleep 30&#34;</span><span class=p>],</span> <span class=n>shell</span><span class=o>=</span><span class=kc>True</span>
</span></span><span class=line><span class=cl>            <span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=n>init</span><span class=p>()</span>
</span></span><span class=line><span class=cl>            <span class=n>login</span><span class=p>()</span>
</span></span></code></pre></div><p>同时在事件响应脚本内追加一行<code>/usr/bin/python3 /root/hrbcu-net.py $INTERFACE $DEVICE $ACTION</code>即可</p><h3 id=adguard-home-配置>AdGuard Home 配置<a hidden class=anchor aria-hidden=true href=#adguard-home-配置>#</a></h3><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>校园网截至现在还没有支持 IPv6&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a href=https://blog.sunbk201.site/posts/ua3f/>校园网防检测: UA3F - 新一代 UA 修改方法</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://sunbk201public.notion.site/UA3F-Clash-16d60a7b5f0e457a9ee97a3be7cbf557>UA3F 与 Clash 从零开始的部署教程</a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://racel.dev/tags/%E6%A0%A1%E5%9B%AD%E7%BD%91/>校园网</a></li><li><a href=https://racel.dev/tags/openwrt/>openwrt</a></li><li><a href=https://racel.dev/tags/%E8%B7%AF%E7%94%B1%E5%99%A8/>路由器</a></li><li><a href=https://racel.dev/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/>计算机网络</a></li></ul><nav class=paginav><a class=prev href=https://racel.dev/posts/markdown-syntax-guide/><span class=title>« Prev</span><br><span>Markdown 语法模板</span></a>
<a class=next href=https://racel.dev/posts/campus-network/><span class=title>Next »</span><br><span>对于所在学校的校园网络了解和研究</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://racel.dev/>racel.researches</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg></a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>